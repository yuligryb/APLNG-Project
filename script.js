// Content for modals
const content = {
    why: {
        title: "Why Does Language Loss Happen?",
        text: `
            <p><strong>Generational language loss occurs when immigrant or heritage languages are gradually replaced by a dominant societal language across one to three generations. This process is not accidental, but structurally reinforced.</strong></p>
            <br>
            <p><strong>Language loss as a predictable social pattern</strong><br>
            Generational language loss is not random. Historical research from 1961 documented how second generation immigrants in the U.S. rejected their parents' languages to assimilate, only to attempt revival later when fluency was already lost. Even large language communities experience rapid decline: Spanish, despite millions of speakers and widespread media visibility, experiences rapid decline by the third generation. The United States is often called a "language graveyard" where immigrant languages disappear by the third generation, demonstrating that language loss is a structural feature of assimilation rather than a failure of specific communities.</p>
            <br>
            <p><strong>Dominant-language schooling</strong><br>
            Children are rapidly immersed in English-only or English-dominant education systems, where success is closely tied to abandoning the home language. Even when families value bilingualism, schools often provide little to no institutional support for maintaining heritage languages.</p>
            <br>
            <p><strong>Assimilation pressure</strong><br>
            Children experience strong social pressure to "fit in," leading many to avoid using their heritage language to prevent being marked as different. Over time, this avoidance accelerates language attrition.</p>
            <br>
            <p><strong>Institutional responsibility shifted to families</strong><br>
            Teachers often believe heritage language maintenance should occur at home, not in schools. This belief allows schools to avoid responsibility while benefiting from English-only efficiency, leaving families isolated in their efforts and making long-term maintenance difficult.</p>
            <br>
            <p><strong>False perception of language security</strong><br>
            In communities with large immigrant populations (such as Spanish speakers in the U.S.), widespread visibility of a language creates the illusion that it is safe, even as children shift to English at record speed.</p>
        `
    },
    how: {
        title: "How Language Loss Happens Across Generations",
        text: `
            <p><strong>Language loss typically follows a predictable three-generation pattern.</strong></p>
            <br>
            <p><strong>Generation 1: Native Speakers</strong><br>
            First-generation immigrants arrive fluent in their native language and use it daily, especially within the home.</p>
            <br>
            <p><strong>Generation 1.5: Partial Shift</strong><br>
            Children who immigrate young or are raised bilingually become dominant in English. Their heritage language weakens due to reduced use, limited schooling in that language, and lack of formal literacy development. Many experience complex emotions during this period, suppressing their heritage language during childhood to assimilate into the host society.</p>
            <br>
            <p><strong>Generation 2 to 3: Attrition or Loss</strong><br>
            By the second or third generation, many individuals understand but cannot speak the heritage language fluently, or abandon it entirely. Linguists describe this as "linguistic death" in the U.S. context.</p>
            <br>
            <p><strong>Education systems and institutional pressure</strong><br>
            Research shows that teachers frequently lack training in multilingual education and view heritage language maintenance as optional rather than academic. Schools actively encourage language shift by treating English dominance as the default requirement for success. This institutional pressure means schools do not remain neutral, but actively shape language outcomes against heritage language maintenance.</p>
        `
    },
    effects: {
        title: "Effects of Generational Language Loss",
        text: `
            <p><strong>Language loss is not just linguistic; it has emotional, cultural, and social consequences.</strong></p>
            <br>
            <p><strong>Linguistic structural change</strong><br>
            Language loss is measurable linguistically. Research on Italian heritage speakers in the UK found systematic grammatical simplification across generations, including reduced use of complex pronoun structures. This demonstrates that heritage speakers are developing stable but reduced language systems shaped by limited input, not simply making mistakes.</p>
            <br>
            <p><strong>Identity and emotional impact</strong><br>
            Personal narratives consistently show that language loss produces emotional harm. Heritage speakers describe shame, frustration, and grief tied to losing linguistic access to family and identity. Many 1.5 generation immigrants report fear of speaking incorrectly, embarrassment, and a sense of cultural disconnection.</p>
            <br>
            <p><strong>Family disconnection</strong><br>
            Loss of a shared language weakens intergenerational bonds, limiting emotional closeness and cultural transmission between parents, grandparents, and children. Communication barriers often develop, creating distances that extend beyond language itself.</p>
            <br>
            <p><strong>Cultural erosion</strong><br>
            Heritage languages carry histories, values, humor, and traditions that cannot be fully translated. When the language fades, cultural knowledge often fades with it.</p>
        `
    },
    solutions: {
        title: "Solutions: What Actually Helps Prevent Language Loss?",
        text: `
            <p><strong>Research is very clear: family effort alone is not enough. Prevention requires systemic change.</strong></p>
            <br>
            <p><strong>Why family effort alone is insufficient</strong><br>
            Many parents attempt to preserve heritage languages through home use, but research consistently shows that these efforts are often insufficient without institutional support. Research shows that even motivated families struggle to maintain language use when children associate English with success and social acceptance. Placing responsibility solely on families ignores the structural pressures children face in school and society. This reinforces the conclusion that language preservation must be supported at the community and policy level.</p>
            <br>
            <p><strong>Institutional support in schools</strong><br>
            Schools must recognize heritage languages as academic assets, not obstacles. Bilingual programs, heritage-language literacy instruction, and teacher training significantly slow language shift.</p>
            <br>
            <p><strong>Early literacy in the home language</strong><br>
            Literacy is often where transmission fails. When children are not taught to read or write in their heritage language, that language becomes increasingly limited to informal contexts. Children who develop reading and writing skills in their heritage language are far more likely to maintain it into adulthood and use it in professional and academic contexts.</p>
            <br>
            <p><strong>Shared responsibility model</strong><br>
            Language maintenance works best when families, schools, and communities share responsibility, rather than placing the burden entirely on parents.</p>
        `
    },
    us: {
        title: "United States",
        text: `
            <p><strong>The Language Graveyard</strong></p>
            <br>
            <p>The U.S. is often described as a "language graveyard," where immigrant languages typically disappear by the third generation, including Spanish despite its widespread visibility.</p>
            <br>
            <p>Despite Spanish speakers numbering in the tens of millions, second and third-generation Hispanic Americans often experience rapid language attrition, particularly in schooling environments that prioritize English-only instruction.</p>
            <br>
            <p><strong>Key Factors:</strong><br>
            • English-dominant education systems with minimal bilingual support<br>
            • Peer pressure to assimilate linguistically<br>
            • Limited heritage language resources in public schools<br>
            • The "false security" of large immigrant communities masking rapid language shift</p>
        `
    },
    uk: {
        title: "United Kingdom",
        text: `
            <p><strong>Family-Centered Maintenance Burden</strong></p>
            <br>
            <p>Heritage language maintenance is largely treated as a family responsibility, with limited institutional support from schools, accelerating language shift.</p>
            <br>
            <p>In the UK, immigrant and heritage language communities receive minimal support from educational institutions, leaving families to shoulder the entire burden of language preservation—a task that becomes increasingly difficult as children integrate into English-dominant peer networks.</p>
            <br>
            <p><strong>Key Challenges:</strong><br>
            • Schools frame heritage language maintenance as optional, "home-only" activity<br>
            • Lack of bilingual or heritage language programs<br>
            • Limited teacher training in multilingual education<br>
            • Insufficient recognition of languages as academic assets</p>
        `
    },
    ireland: {
        title: "Ireland",
        text: `
            <p><strong>Immigrant Language Loss & Educational Gaps</strong></p>
            <br>
            <p>1.5-generation immigrants report fear, frustration, and shame related to losing their first language due to lack of educational support during childhood.</p>
            <br>
            <p>Immigrants and their children arriving in Ireland face similar challenges: limited institutional support for heritage languages, schooling systems that don't support bilingualism, and social pressure to adopt English as the primary language of communication.</p>
            <br>
            <p><strong>Emotional Toll:</strong><br>
            • Feelings of loss and regret about language attrition<br>
            • Identity confusion and disconnection from cultural roots<br>
            • Intergenerational communication barriers with grandparents<br>
            • Shame associated with not maintaining the heritage language</p>
        `
    },
    southasia: {
        title: "South Asia & Pakistan/India",
        text: `
            <p><strong>Heritage Language Shift in Diaspora Communities</strong></p>
            <br>
            <p>Families show a generational shift from heritage-language dominance to English dominance, with heritage literacy often declining despite strong oral traditions.</p>
            <br>
            <p>South Asian immigrants in the UK and other Western countries experience rapid language shift. While oral fluency may persist longer due to strong family and community networks, written literacy in heritage languages is often lost by the second generation, limiting access to literature, education, and cultural knowledge.</p>
            <br>
            <p><strong>Key Dynamics:</strong><br>
            • Strong oral traditions but weak literacy maintenance<br>
            • English seen as key to educational and economic success<br>
            • Limited heritage language schooling options<br>
            • Cultural identity maintained through food and customs but not language</p>
        `
    },
    asian: {
        title: "Asian-American Communities",
        text: `
            <p><strong>Language Loss Despite Active Family Effort</strong></p>
            <br>
            <p>Even families who actively try to maintain their language struggle due to schooling, peer pressure, and English-only norms.</p>
            <br>
            <p>Asian-American families often invest significant effort in heritage language maintenance—hiring tutors, attending weekend language schools, and speaking at home—yet still experience language loss. The gap between home language and school language is often too wide for children to bridge without systemic institutional support.</p>
            <br>
            <p><strong>Common Struggles:</strong><br>
            • Weekend heritage language classes insufficient for literacy development<br>
            • English-only peer groups and social dynamics<br>
            • Limited portrayals of Asian languages in media and education<br>
            • Perception that heritage language skills don't "count" academically</p>
        `
    },
    identity: {
        title: "Generational Identity & the 1.5 Generation",
        text: `
            <p><strong>The 1.5 Generation: Between Cultures</strong></p>
            <br>
            <p>A key group affected by generational language loss is the 1.5 generation—individuals who immigrate as children and complete their education in the host country. These individuals often retain emotional ties to their heritage language while becoming dominant in the societal language.</p>
            <br>
            <p><strong>Language and Hybrid Identity</strong><br>
            Language plays a central role in this hybrid identity. Many Russian Israelis reported distancing themselves from Russian as children to assimilate, only to later attempt to reconnect with it as adults. This pattern mirrors findings in other immigrant communities where heritage language loss is initially encouraged for survival and acceptance, then later mourned as part of lost identity.</p>
            <br>
            <p>This research shows that language loss is not simply a matter of forgetting words but a restructuring of identity that often resurfaces later in life.</p>
        `
    },
    inequality: {
        title: "Language Loss & Social Inequality",
        text: `
            <p><strong>Power, Institutions, and Linguistic Conformity</strong></p>
            <br>
            <p>Language loss is closely connected to power and inequality. Teachers and institutions often treat English as a requirement for social legitimacy, framing other languages as barriers rather than resources. Teachers frequently position parents and children as responsible for maintaining heritage languages, while schools avoid institutional responsibility.</p>
            <br>
            <p><strong>Discrimination and Language Suppression</strong><br>
            This same pattern appears across immigrant communities. Russian-speaking immigrants experienced pressure to suppress linguistic and cultural markers to avoid discrimination. Even when bilingualism was socially accepted, heritage language use was often limited to private spaces, reinforcing the idea that public success required linguistic conformity.</p>
            <br>
            <p>These findings demonstrate that generational language loss is shaped by structural inequality rather than personal failure. Language maintenance is fundamentally a matter of power and access to resources.</p>
        `
    },
    literacy: {
        title: "Literacy Loss vs. Spoken Language",
        text: `
            <p><strong>A Critical but Often Overlooked Distinction</strong></p>
            <br>
            <p>Language loss is often misunderstood as a decline in speaking ability alone. Research on Pakistani and Indian heritage families shows that oral use of heritage languages may persist while literacy declines sharply, especially across generations.</p>
            <br>
            <p><strong>Why Literacy Matters</strong><br>
            When children are not taught to read or write in their heritage language, that language becomes increasingly limited to informal or emotional contexts. Over time, this restricts vocabulary, complexity, and long-term survival. This explains why many heritage speakers report understanding a language but being unable to use it fluently or confidently as adults.</p>
            <br>
            <p>This distinction is important for understanding why heritage languages disappear even when families continue speaking them at home. Without literacy development, the language cannot be maintained across generations or used in academic and professional contexts.</p>
        `
    },
    emotional: {
        title: "Emotional Consequences of Language Loss",
        text: `
            <p><strong>Grief, Shame, and Cultural Displacement</strong></p>
            <br>
            <p>Personal narratives consistently show that language loss produces emotional harm. Heritage speakers describe shame, frustration, and grief tied to losing linguistic access to family and identity. These emotions are deeply personal but also widespread across immigrant communities.</p>
            <br>
            <p><strong>Mental Health and Belonging</strong><br>
            Modern studies of 1.5-generation immigrants report fear of sounding inadequate, embarrassment when speaking their first language, and a sense of cultural displacement. Many individuals describe feeling "not enough"—neither fully fluent in their heritage language nor fully accepted in the dominant culture.</p>
            <br>
            <p>Together, these sources show that generational language loss affects mental health, self-worth, and belonging, not just communication. Understanding these emotional dimensions is essential for recognizing language loss as a social justice issue.</p>
        `
    },
    italy_uk: {
        title: "Italian Heritage in the UK",
        text: `
            <p><strong>Linguistic Change Across Generations</strong></p>
            <br>
            <p>Heritage speakers of Italian in the UK show measurable grammatical change across generations, including loss of complex pronoun structures, demonstrating how language transmission weakens even when families continue using the language at home.</p>
            <br>
            <p>This finding shows that language loss is not only social or emotional, but also structural and linguistic. Grammar and vocabulary shift in predictable ways as a language is transmitted across generations with reduced input and use.</p>
        `
    },
    europe_post_wwii: {
        title: "Post-WWII Europe Migration",
        text: `
            <p><strong>Historical Continuity of Language Shift</strong></p>
            <br>
            <p>Historical reporting shows that second-generation immigrant children often rejected their parents' languages in favor of assimilation, only for later generations to attempt cultural revival after the language was already weakened.</p>
            <br>
            <p>This historical pattern proves that generational language loss is not a new phenomenon. The cycle of language suppression, loss, and belated cultural recovery has repeated across different immigrant communities and time periods.</p>
        `
    },
    los_angeles: {
        title: "Los Angeles, USA",
        text: `
            <p><strong>The Illusion of Language Security</strong></p>
            <br>
            <p>Despite constant exposure to Spanish-language media, children of immigrants overwhelmingly shift to English dominance, showing that visibility does not equal intergenerational transmission.</p>
            <br>
            <p>This finding reinforces the concept of "false language security"—the dangerous misconception that a language is safe simply because many people speak it in a community.</p>
        `
    },
    california_uni: {
        title: "California Universities",
        text: `
            <p><strong>Semi-speakers and Educational Pressure</strong></p>
            <br>
            <p>Asian-American college students report becoming semi-speakers of their heritage language by adolescence, even when parents actively attempted maintenance, due to English-dominant schooling and peer environments.</p>
            <br>
            <p>This finding ties language loss directly to education systems, showing how schooling choices fundamentally shape heritage language outcomes.</p>
        `
    },
    northern_england: {
        title: "Northern England",
        text: `
            <p><strong>Literacy vs. Oral Language in South Asian Communities</strong></p>
            <br>
            <p>Pakistani and Indian heritage families demonstrate a generational shift where English literacy is prioritized while heritage-language literacy declines, limiting long-term language survival.</p>
            <br>
            <p>This helps distinguish spoken use from literacy loss—a critical distinction for understanding why languages disappear even when families try to maintain them.</p>
        `
    },
    tel_aviv: {
        title: "Tel Aviv, Israel",
        text: `
            <p><strong>Delayed Identity Recovery</strong></p>
            <br>
            <p>Russian Israeli 1.5-generation adults increasingly reclaim Russian language and culture in adulthood after suppressing it during childhood to assimilate into Israeli society. This pattern shows how language loss is often reversed later in life, when individuals reclaim their heritage.</p>
            <br>
            <p>This delayed identity recovery is a powerful concept showing that language loss is not permanent, but depends on opportunity and institutional support.</p>
        `
    },
    ireland_policy: {
        title: "Ireland: Education Policy",
        text: `
            <p><strong>Policy as Prevention</strong></p>
            <br>
            <p>Ireland introduced national language strategies after recognizing that earlier immigrant generations experienced language loss due to lack of institutional support, highlighting how policy can either prevent or accelerate attrition.</p>
            <br>
            <p>This pin supports the solutions section, showing that systemic change through policy is possible and effective.</p>
        `
    },
    sources: {
        title: "Research Sources",
        text: `
            <p><strong>All sources used in this project are peer-reviewed academic journals, ERIC publications, and historical reporting. Direct links are provided for verification.</strong></p>
            <br>
            <p><strong>1. Cunningham, Clare (2020)</strong><br>
            When "Home Languages" Become "Holiday Languages": Teachers' Discourses about Responsibility for Maintaining Languages Beyond English<br>
            <em>Language, Culture and Curriculum</em><br>
            <a href="https://doi.org/10.1080/07908318.2019.1619751" target="_blank">https://doi.org/10.1080/07908318.2019.1619751</a></p>
            <br>
            <p><strong>2. Czaykowska, Ruta (1993)</strong><br>
            My Polish Is Dying<br>
            <em>TEANGA: Journal of the Irish Association for Applied Linguistics</em><br>
            <a href="https://journal.teanga.ie/index.php/teanga/article/view/92" target="_blank">https://journal.teanga.ie/index.php/teanga/article/view/92</a></p>
            <br>
            <p><strong>3. Gilroy, Marilyn (2007)</strong><br>
            Español in the "Language Graveyard"<br>
            <em>The Hispanic Outlook in Higher Education</em><br>
            <a href="https://www.proquest.com/docview/219294516" target="_blank">https://www.proquest.com/docview/219294516</a></p>
            <br>
            <p><strong>4. Hinton, Leanne (1999)</strong><br>
            Involuntary Language Loss among Immigrants: Asian-American Linguistic Autobiographies<br>
            <em>ERIC Digest</em><br>
            <a href="https://eric.ed.gov/?id=ED436982" target="_blank">https://eric.ed.gov/?id=ED436982</a></p>
            <br>
            <p><strong>5. Little, Sabine (2017)</strong><br>
            A Generational Arc: Early Literacy Practices among Pakistani and Indian Heritage Language Families<br>
            <em>International Journal of Early Years Education</em><br>
            <a href="https://doi.org/10.1080/09669760.2017.1341302" target="_blank">https://doi.org/10.1080/09669760.2017.1341302</a></p>
            <br>
            <p><strong>6. Remennick, Larissa and Anna Prashizky (2019)</strong><br>
            Generation 1.5 of Russian Israelis: Integrated but Distinct<br>
            <em>Journal of Modern Jewish Studies</em><br>
            <a href="https://doi.org/10.1080/14725886.2018.1537212" target="_blank">https://doi.org/10.1080/14725886.2018.1537212</a></p>
            <br>
            <p><strong>7. Smith, Giuditta et al. (2023)</strong><br>
            Inter-generational Attrition: Language Transmission between Long-Term UK Residents and Heritage Speakers of Italian<br>
            <em>Linguistic Approaches to Bilingualism</em><br>
            <a href="https://doi.org/10.1075/lab.23002.smi" target="_blank">https://doi.org/10.1075/lab.23002.smi</a></p>
            <br>
            <p><strong>8. Tolchin, Martin (1961)</strong><br>
            Immigrants' Children Revive the Past: The Second Generation Is Looking Back to Cultural Heritage<br>
            <em>The New York Times</em><br>
            <a href="https://www.nytimes.com/1961/12/12/archives/immigrants-children-revive-the-past-the-second-generation.html" target="_blank">https://www.nytimes.com/1961/12/12/archives/immigrants-children-revive-the-past-the-second-generation.html</a></p>
            <br>
            <p><strong>9. Toth, Patricia and Emma Riordan (2023)</strong><br>
            "My Polish Is Dying, and I'm Really Upset About It": First Language Experiences of the 1.5 Generation of Immigrants in Ireland<br>
            <em>Linguistic Approaches to Bilingualism</em><br>
            <a href="https://doi.org/10.1075/lab.21028.tot" target="_blank">https://doi.org/10.1075/lab.21028.tot</a></p>
        `
    }
};

// ============================================================
// GLOBE.GL IMPLEMENTATION - REPLACE YOUR OLD GLOBE CODE HERE
// ============================================================

let world;
let globeInitialized = false;
let clickedPins = new Set();

// Pin locations with their modal IDs
const locationMarkers = [
    { lat: 38, lng: -100, label: 'United States', id: 'us', size: 1.2, color: '#ff4757' },
    { lat: 54, lng: -2, label: 'United Kingdom', id: 'uk', size: 1.2, color: '#ff4757' },
    { lat: 53, lng: -8, label: 'Ireland', id: 'ireland', size: 1.2, color: '#ff4757' },
    { lat: 20, lng: 78, label: 'South Asia', id: 'southasia', size: 1.2, color: '#ff4757' },
    { lat: 37, lng: -120, label: 'Asian-American Communities', id: 'asian', size: 1.2, color: '#ff4757' },
    { lat: 43, lng: 12, label: 'Italian Heritage in UK', id: 'italy_uk', size: 1.2, color: '#ff4757' },
    { lat: 50, lng: 10, label: 'Post-WWII Europe Migration', id: 'europe_post_wwii', size: 1.2, color: '#ff4757' },
    { lat: 34.05, lng: -118.2, label: 'Los Angeles, USA', id: 'los_angeles', size: 1.2, color: '#ff4757' },
    { lat: 37.2, lng: -120.5, label: 'California Universities', id: 'california_uni', size: 1.2, color: '#ff4757' },
    { lat: 54.5, lng: -2, label: 'Northern England', id: 'northern_england', size: 1.2, color: '#ff4757' },
    { lat: 32.09, lng: 34.78, label: 'Tel Aviv, Israel', id: 'tel_aviv', size: 1.2, color: '#ff4757' },
    { lat: 53, lng: -8, label: 'Ireland: Education Policy', id: 'ireland_policy', size: 1.2, color: '#ff4757' }
];

const uniformColor = '#90EE90'; // Light green for land
const waterColor = '#000080'; // Navy blue for water

// Migration/connection arcs between regions
const migrationArcs = [
    // Heritage communities IN the UK
    { startLat: 43, startLng: 12, endLat: 54, endLng: -2, label: 'Italian Heritage in UK' },
    { startLat: 20, startLng: 78, endLat: 54, endLng: -2, label: 'South Asian Heritage in UK' }
];

function initGlobe() {
    if (globeInitialized) return;
    
    const container = document.getElementById('globeViz');
    
    world = Globe()
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .backgroundColor('#000000')
        .lineHoverPrecision(0)
        .atmosphereColor('#1a1a2e')
        .atmosphereAltitude(0.1)
        .pointsData(locationMarkers)
        .pointAltitude(0.02)
        .pointRadius('size')
        .pointColor('color')
        .pointLabel(d => `<div style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white; font-weight: bold;">${d.label}</div>`)
        .onPointClick(point => {
            clickedPins.add(point.id);
            updatePinList();
            updatePinColors();
            openInfoPanel(point.id);
        })
        .pointsMerge(false)
        .arcsData(migrationArcs)
        .arcColor(() => 'rgba(255, 71, 87, 0.4)')
        .arcAltitude(() => 0.25)
        .arcStroke(() => 0.8)
        .arcDashInitialGap(() => 0)
        (container);
    
    // Load and display countries
    loadCountries();
    
    // Set initial point of view
    world.pointOfView({ lat: 20, lng: 0, altitude: 2.5 });
    
    // Enable auto-rotation
    world.controls().autoRotate = true;
    world.controls().autoRotateSpeed = 0.5;
    world.controls().enableZoom = true;
    
    globeInitialized = true;
    
    // Resize globe to fit container
    resizeGlobe();
    
    // Populate pins list
    updatePinList();
}

function updatePinList() {
    const container = document.getElementById('pinsPopupContent');
    if (!container) return;
    
    container.innerHTML = locationMarkers.map(pin => 
        `<div class="pin-item ${clickedPins.has(pin.id) ? 'clicked' : ''}" onclick="clickPin('${pin.id}')">${pin.label}</div>`
    ).join('');
}

function clickPin(pinId) {
    clickedPins.add(pinId);
    updatePinList();
    updatePinColors();
    openInfoPanel(pinId);
}

function updatePinColors() {
    if (!world) return;
    world.pointColor(point => clickedPins.has(point.id) ? '#2196F3' : '#ff4757');
}

async function loadCountries() {
    try {
        const res = await fetch('https://unpkg.com/world-atlas@2/countries-110m.json');
        const worldData = await res.json();
        const countries = topojson.feature(worldData, worldData.objects.countries);
        
        // Update the globe with the countries
        world
            .polygonsData(countries.features)
            .polygonCapColor(() => uniformColor)
            .polygonSideColor(() => waterColor)
            .polygonStrokeColor(() => '#1a1a1a')
            .polygonLabel(({ properties: d }) => `
                <div style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white;">
                    <b>${d.name || 'Country'}</b>
                </div>
            `)
            .polygonsTransitionDuration(600);
    } catch (error) {
        console.error('Error loading countries:', error);
        // Fallback: globe will still work without country data
    }
}

function resizeGlobe() {
    if (!world) return;
    const container = document.getElementById('globeViz');
    world.width(container.clientWidth);
    world.height(container.clientHeight);
}

function toggleRotation() {
    if (!world) return;
    const controls = world.controls();
    controls.autoRotate = !controls.autoRotate;
}

function resetView() {
    if (!world) return;
    world.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 1000);
    world.controls().autoRotate = true;
}

// ============================================================
// PAGE NAVIGATION AND MODAL FUNCTIONS - KEEP ALL OF THIS
// ============================================================

// Page navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(pageId).classList.add('active');
    
    // Find and activate the corresponding nav button
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(pageId === 'bubbles' ? 'overview' : 'global')) {
            btn.classList.add('active');
        }
    });
    
    if (pageId === 'globe') {
        setTimeout(() => {
            initGlobe();
        }, 100);
    }
}

function openModal(contentId) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    
    modalTitle.textContent = content[contentId].title;
    modalText.innerHTML = content[contentId].text;
    
    modal.classList.add('active');
}

function closeModal(event) {
    if (!event || event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
    }
}

function openInfoPanel(contentId) {
    const panel = document.getElementById('infoPanel');
    const title = document.getElementById('infoPanelTitle');
    const contentDiv = document.getElementById('infoPanelContent');
    
    if (content[contentId]) {
        title.textContent = content[contentId].title;
        contentDiv.innerHTML = content[contentId].text;
        panel.classList.add('active');
    }
}

function closeInfoPanel() {
    document.getElementById('infoPanel').classList.remove('active');
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

function openSourcesPanel() {
    const panel = document.getElementById('sourcesPanel');
    const contentDiv = document.getElementById('sourcesPanelContent');
    
    if (content['sources']) {
        contentDiv.innerHTML = content['sources'].text;
        panel.classList.add('active');
    }
}

function closeSourcesPanel() {
    document.getElementById('sourcesPanel').classList.remove('active');
}

// Handle window resize
window.addEventListener('resize', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeGlobe();
    }
});

// Initialize on load
window.addEventListener('load', () => {
    // Globe will be initialized when the user navigates to that page
});
