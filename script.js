// Content for modals
const content = {
    why: {
        title: "Why Does Language Loss Happen?",
        text: `
            <p><strong>Language loss occurs due to several interconnected factors:</strong></p>
            <br>
            <p><strong>1. Migration & Displacement</strong><br>
            When families move to new countries, dominant languages often take precedence in education, work, and social integration. Children may prioritize the majority language to fit in with peers.</p>
            <br>
            <p><strong>2. Social Pressure & Stigma</strong><br>
            Heritage languages can be stigmatized or viewed as "less valuable" than dominant languages, leading speakers to abandon them in favor of linguistic assimilation.</p>
            <br>
            <p><strong>3. Limited Use in Daily Life</strong><br>
            When heritage languages aren't reinforced in schools, media, or public spaces, younger generations have fewer opportunities and motivations to maintain fluency.</p>
            <br>
            <p><strong>4. Generational Disconnect</strong><br>
            As older generations pass away, the primary speakers and cultural transmitters of heritage languages disappear, creating a critical break in language transmission.</p>
        `
    },
    how: {
        title: "How Language Loss Happens",
        text: `
            <p><strong>Language shift occurs through a predictable pattern:</strong></p>
            <br>
            <p><strong>Generation 1: Immigrants/Original Speakers</strong><br>
            Fully fluent in heritage language, limited proficiency in dominant language. Use heritage language at home.</p>
            <br>
            <p><strong>Generation 2: First Generation Born in New Country</strong><br>
            Bilingual but may prefer dominant language. Understand heritage language but respond in dominant language. Experience pressure to assimilate.</p>
            <br>
            <p><strong>Generation 3: Grandchildren</strong><br>
            Limited or no fluency in heritage language. May understand some phrases but cannot speak fluently. Primarily use dominant language in all contexts.</p>
            <br>
            <p><strong>The Critical Period</strong><br>
            Research shows that without active maintenance, heritage languages can be lost within 2-3 generations. The transition from Generation 2 to 3 is particularly critical.</p>
        `
    },
    effects: {
        title: "Effects of Language Loss",
        text: `
            <p><strong>The consequences extend far beyond communication:</strong></p>
            <br>
            <p><strong>1. Loss of Cultural Identity</strong><br>
            Language carries culture, traditions, and worldviews. When a language dies, unique ways of understanding and expressing reality disappear with it.</p>
            <br>
            <p><strong>2. Family Disconnect</strong><br>
            Grandchildren who cannot speak heritage languages struggle to communicate with grandparents, creating emotional distance and breaking family bonds.</p>
            <br>
            <p><strong>3. Feelings of Inadequacy</strong><br>
            Many heritage speakers report feeling "not enough"‚Äîneither fully fluent in heritage language nor fully accepted in the dominant culture. This creates identity struggles.</p>
            <br>
            <p><strong>4. Loss of Linguistic Diversity</strong><br>
            Each language represents unique knowledge systems, cognitive patterns, and cultural wisdom. Global linguistic diversity shrinks as languages disappear.</p>
            <br>
            <p><strong>5. Community Fragmentation</strong><br>
            Shared language creates community cohesion. Language loss can fragment ethnic communities and weaken social support networks.</p>
        `
    },
    solutions: {
        title: "Solutions & Revitalization",
        text: `
            <p><strong>Preventing and reversing language loss requires multi-level intervention:</strong></p>
            <br>
            <p><strong>1. Family-Level Strategies</strong><br>
            ‚Ä¢ Consistent use of heritage language at home<br>
            ‚Ä¢ Creating engaging, positive associations with the language<br>
            ‚Ä¢ Connecting children with fluent speakers (grandparents, community members)</p>
            <br>
            <p><strong>2. Educational Support</strong><br>
            ‚Ä¢ Heritage language classes in schools<br>
            ‚Ä¢ Dual-language immersion programs<br>
            ‚Ä¢ Reading materials and resources for young learners<br>
            ‚Ä¢ Validating multilingualism as an asset, not a deficit</p>
            <br>
            <p><strong>3. Community Resources</strong><br>
            ‚Ä¢ Language nests and cultural programs<br>
            ‚Ä¢ Media and entertainment in heritage languages<br>
            ‚Ä¢ Community events that celebrate linguistic diversity<br>
            ‚Ä¢ Digital resources and apps for language learning</p>
            <br>
            <p><strong>4. Policy & Institutional Change</strong><br>
            ‚Ä¢ Recognition of linguistic rights<br>
            ‚Ä¢ Funding for language preservation programs<br>
            ‚Ä¢ Reducing stigma around non-dominant languages<br>
            ‚Ä¢ Supporting heritage language research and documentation</p>
            <br>
            <p><strong>5. Embracing Multilingualism</strong><br>
            Research shows you can be fluent in multiple languages‚Äîit's beneficial for cognitive development, cultural identity, and professional opportunities. Language loss is preventable with the right support.</p>
        `
    },
    italy: {
        title: "Italian Language Heritage",
        text: `
            <p><strong>The Italian-American Experience</strong></p>
            <br>
            <p>Italian immigrants brought rich linguistic diversity to the United States, including various regional dialects. However, second and third-generation Italian-Americans often experienced significant language loss.</p>
            <br>
            <p><strong>Key Challenges:</strong><br>
            ‚Ä¢ Pressure to assimilate during the early-mid 20th century<br>
            ‚Ä¢ Italian was sometimes discouraged in schools<br>
            ‚Ä¢ Regional dialects (Sicilian, Neapolitan) were often replaced by Standard Italian or English<br>
            ‚Ä¢ Limited formal education in Italian language and culture</p>
            <br>
            <p><strong>Current Status:</strong><br>
            Many third and fourth-generation Italian-Americans report understanding some Italian phrases but cannot maintain conversations. Interest in reclaiming heritage language is growing, with adult learners seeking to reconnect with their roots.</p>
            <br>
            <p><strong>Preservation Efforts:</strong><br>
            Italian cultural centers, language classes, and study abroad programs help heritage speakers reconnect with their linguistic heritage.</p>
        `
    },
    indigenous: {
        title: "Indigenous Language Rights",
        text: `
            <p><strong>Indigenous Languages Face Unique Challenges</strong></p>
            <br>
            <p>Indigenous communities worldwide experience the most severe language loss, with many languages critically endangered or already extinct.</p>
            <br>
            <p><strong>Historical Context:</strong><br>
            ‚Ä¢ Forced attendance at boarding schools where native languages were forbidden<br>
            ‚Ä¢ Systematic cultural suppression and assimilation policies<br>
            ‚Ä¢ Physical punishment for speaking heritage languages<br>
            ‚Ä¢ Intergenerational trauma affecting language transmission</p>
            <br>
            <p><strong>Current Crisis:</strong><br>
            UNESCO estimates that one indigenous language dies every two weeks. Many languages have fewer than 100 fluent speakers, and most are elderly.</p>
            <br>
            <p><strong>Revitalization Movements:</strong><br>
            ‚Ä¢ Language immersion schools (like Hawaiian language nests)<br>
            ‚Ä¢ Master-apprentice programs pairing elders with young learners<br>
            ‚Ä¢ Digital documentation and archiving projects<br>
            ‚Ä¢ Legal recognition of indigenous language rights<br>
            ‚Ä¢ Community-driven revitalization programs</p>
            <br>
            <p><strong>Success Stories:</strong><br>
            Hawaiian, MƒÅori, and some Native American languages have seen successful revitalization through dedicated community efforts and institutional support.</p>
        `
    },
    immigrant: {
        title: "Immigrant Community Languages",
        text: `
            <p><strong>The Immigrant Language Journey</strong></p>
            <br>
            <p>Immigrant communities across the globe face similar patterns of language shift and loss, regardless of the specific languages involved.</p>
            <br>
            <p><strong>Common Experiences:</strong><br>
            ‚Ä¢ Children become interpreters for parents, reversing family dynamics<br>
            ‚Ä¢ School systems that don't support bilingualism<br>
            ‚Ä¢ Peer pressure to speak only the dominant language<br>
            ‚Ä¢ Parents may stop speaking heritage language thinking it will help children succeed</p>
            <br>
            <p><strong>The "Linguistically Dead" Phenomenon:</strong><br>
            Many heritage speakers describe feeling "linguistically dead" when they lack fluency in their heritage language‚Äîexperiencing loss of connection to family history, culture, and identity.</p>
            <br>
            <p><strong>The Multilingual Advantage:</strong><br>
            Research consistently shows that bilingualism and multilingualism offer cognitive, social, and economic benefits. Children can be fully proficient in multiple languages with proper support.</p>
            <br>
            <p><strong>Supporting Heritage Language Development:</strong><br>
            ‚Ä¢ Consistent family language policies<br>
            ‚Ä¢ Access to books, media, and entertainment in heritage languages<br>
            ‚Ä¢ Community language schools and cultural programs<br>
            ‚Ä¢ Positive reinforcement and celebration of multilingualism<br>
            ‚Ä¢ Connection with extended family and homeland</p>
        `
    }
};

// ============================================================
// GLOBE.GL IMPLEMENTATION - REPLACE YOUR OLD GLOBE CODE HERE
// ============================================================

let world;
let globeInitialized = false;

// Pin locations with their modal IDs
const locationMarkers = [
    { lat: 42, lng: 12, label: 'üáÆüáπ Italy', id: 'italy', size: 1.2, color: '#ff4757' },
    { lat: 40, lng: -100, label: 'üåé Indigenous Americas', id: 'indigenous', size: 1.2, color: '#ff4757' },
    { lat: 35, lng: 105, label: 'üåè Asia', id: 'immigrant', size: 1.2, color: '#ff4757' },
    { lat: 0, lng: 20, label: 'üåç Africa', id: 'immigrant', size: 1.2, color: '#ff4757' },
    { lat: -25, lng: 135, label: 'üá¶üá∫ Australia', id: 'immigrant', size: 1.2, color: '#ff4757' }
];

const uniformColor = '#34A56F'; // Uniform color for all countries

function initGlobe() {
    if (globeInitialized) return;
    
    const container = document.getElementById('globeViz');
    
    world = Globe()
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
        .lineHoverPrecision(0)
        .atmosphereColor('#667eea')
        .atmosphereAltitude(0.25)
        .pointsData(locationMarkers)
        .pointAltitude(0.02)
        .pointRadius('size')
        .pointColor('color')
        .pointLabel(d => `<div style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white; font-weight: bold;">${d.label}</div>`)
        .onPointClick(point => {
            openModal(point.id);
        })
        .pointsMerge(false)
        (container);
    
    // Load and display countries
    loadCountries();
    
    // Set initial point of view
    world.pointOfView({ lat: 20, lng: 0, altitude: 2.5 });
    
    // Enable auto-rotation
    world.controls().autoRotate = true;
    world.controls().autoRotateSpeed = 0.5;
    world.controls().enableZoom = true;
    
    globeInitialized = true;
    
    // Resize globe to fit container
    resizeGlobe();
}

async function loadCountries() {
    try {
        const res = await fetch('https://unpkg.com/world-atlas@2/countries-110m.json');
        const worldData = await res.json();
        const countries = topojson.feature(worldData, worldData.objects.countries);
        
        // Update the globe with the countries
        world
            .polygonsData(countries.features)
            .polygonCapColor(() => uniformColor)
            .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
            .polygonStrokeColor(() => '#111')
            .polygonLabel(({ properties: d }) => `
                <div style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white;">
                    <b>${d.name || 'Country'}</b>
                </div>
            `)
            .polygonsTransitionDuration(600);
    } catch (error) {
        console.error('Error loading countries:', error);
        // Fallback: globe will still work without country data
    }
}

function resizeGlobe() {
    if (!world) return;
    const container = document.getElementById('globeViz');
    world.width(container.clientWidth);
    world.height(container.clientHeight);
}

function toggleRotation() {
    if (!world) return;
    const controls = world.controls();
    controls.autoRotate = !controls.autoRotate;
}

function resetView() {
    if (!world) return;
    world.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 1000);
    world.controls().autoRotate = true;
}

// ============================================================
// PAGE NAVIGATION AND MODAL FUNCTIONS - KEEP ALL OF THIS
// ============================================================

// Page navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(pageId).classList.add('active');
    
    // Find and activate the corresponding nav button
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(pageId === 'bubbles' ? 'overview' : 'global')) {
            btn.classList.add('active');
        }
    });
    
    if (pageId === 'globe') {
        setTimeout(() => {
            initGlobe();
        }, 100);
    }
}

function openModal(contentId) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    
    modalTitle.textContent = content[contentId].title;
    modalText.innerHTML = content[contentId].text;
    
    modal.classList.add('active');
}

function closeModal(event) {
    if (!event || event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// Handle window resize
window.addEventListener('resize', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeGlobe();
    }
});

// Initialize on load
window.addEventListener('load', () => {
    // Globe will be initialized when the user navigates to that page
});
