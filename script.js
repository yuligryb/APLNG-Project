// Content for modals
const content = {
    why: {
        title: "Why Does Language Loss Happen?",
        text: `
            <p><strong>Language loss occurs due to several interconnected factors:</strong></p>
            <br>
            <p><strong>1. Migration & Displacement</strong><br>
            When families move to new countries, dominant languages often take precedence in education, work, and social integration. Children may prioritize the majority language to fit in with peers.</p>
            <br>
            <p><strong>2. Social Pressure & Stigma</strong><br>
            Heritage languages can be stigmatized or viewed as "less valuable" than dominant languages, leading speakers to abandon them in favor of linguistic assimilation.</p>
            <br>
            <p><strong>3. Limited Use in Daily Life</strong><br>
            When heritage languages aren't reinforced in schools, media, or public spaces, younger generations have fewer opportunities and motivations to maintain fluency.</p>
            <br>
            <p><strong>4. Generational Disconnect</strong><br>
            As older generations pass away, the primary speakers and cultural transmitters of heritage languages disappear, creating a critical break in language transmission.</p>
        `
    },
    how: {
        title: "How Language Loss Happens",
        text: `
            <p><strong>Language shift occurs through a predictable pattern:</strong></p>
            <br>
            <p><strong>Generation 1: Immigrants/Original Speakers</strong><br>
            Fully fluent in heritage language, limited proficiency in dominant language. Use heritage language at home.</p>
            <br>
            <p><strong>Generation 2: First Generation Born in New Country</strong><br>
            Bilingual but may prefer dominant language. Understand heritage language but respond in dominant language. Experience pressure to assimilate.</p>
            <br>
            <p><strong>Generation 3: Grandchildren</strong><br>
            Limited or no fluency in heritage language. May understand some phrases but cannot speak fluently. Primarily use dominant language in all contexts.</p>
            <br>
            <p><strong>The Critical Period</strong><br>
            Research shows that without active maintenance, heritage languages can be lost within 2-3 generations. The transition from Generation 2 to 3 is particularly critical.</p>
        `
    },
    effects: {
        title: "Effects of Language Loss",
        text: `
            <p><strong>The consequences extend far beyond communication:</strong></p>
            <br>
            <p><strong>1. Loss of Cultural Identity</strong><br>
            Language carries culture, traditions, and worldviews. When a language dies, unique ways of understanding and expressing reality disappear with it.</p>
            <br>
            <p><strong>2. Family Disconnect</strong><br>
            Grandchildren who cannot speak heritage languages struggle to communicate with grandparents, creating emotional distance and breaking family bonds.</p>
            <br>
            <p><strong>3. Feelings of Inadequacy</strong><br>
            Many heritage speakers report feeling "not enough"‚Äîneither fully fluent in heritage language nor fully accepted in the dominant culture. This creates identity struggles.</p>
            <br>
            <p><strong>4. Loss of Linguistic Diversity</strong><br>
            Each language represents unique knowledge systems, cognitive patterns, and cultural wisdom. Global linguistic diversity shrinks as languages disappear.</p>
            <br>
            <p><strong>5. Community Fragmentation</strong><br>
            Shared language creates community cohesion. Language loss can fragment ethnic communities and weaken social support networks.</p>
        `
    },
    solutions: {
        title: "Solutions & Revitalization",
        text: `
            <p><strong>Preventing and reversing language loss requires multi-level intervention:</strong></p>
            <br>
            <p><strong>1. Family-Level Strategies</strong><br>
            ‚Ä¢ Consistent use of heritage language at home<br>
            ‚Ä¢ Creating engaging, positive associations with the language<br>
            ‚Ä¢ Connecting children with fluent speakers (grandparents, community members)</p>
            <br>
            <p><strong>2. Educational Support</strong><br>
            ‚Ä¢ Heritage language classes in schools<br>
            ‚Ä¢ Dual-language immersion programs<br>
            ‚Ä¢ Reading materials and resources for young learners<br>
            ‚Ä¢ Validating multilingualism as an asset, not a deficit</p>
            <br>
            <p><strong>3. Community Resources</strong><br>
            ‚Ä¢ Language nests and cultural programs<br>
            ‚Ä¢ Media and entertainment in heritage languages<br>
            ‚Ä¢ Community events that celebrate linguistic diversity<br>
            ‚Ä¢ Digital resources and apps for language learning</p>
            <br>
            <p><strong>4. Policy & Institutional Change</strong><br>
            ‚Ä¢ Recognition of linguistic rights<br>
            ‚Ä¢ Funding for language preservation programs<br>
            ‚Ä¢ Reducing stigma around non-dominant languages<br>
            ‚Ä¢ Supporting heritage language research and documentation</p>
            <br>
            <p><strong>5. Embracing Multilingualism</strong><br>
            Research shows you can be fluent in multiple languages‚Äîit's beneficial for cognitive development, cultural identity, and professional opportunities. Language loss is preventable with the right support.</p>
        `
    },
    italy: {
        title: "Italian Language Heritage",
        text: `
            <p><strong>The Italian-American Experience</strong></p>
            <br>
            <p>Italian immigrants brought rich linguistic diversity to the United States, including various regional dialects. However, second and third-generation Italian-Americans often experienced significant language loss.</p>
            <br>
            <p><strong>Key Challenges:</strong><br>
            ‚Ä¢ Pressure to assimilate during the early-mid 20th century<br>
            ‚Ä¢ Italian was sometimes discouraged in schools<br>
            ‚Ä¢ Regional dialects (Sicilian, Neapolitan) were often replaced by Standard Italian or English<br>
            ‚Ä¢ Limited formal education in Italian language and culture</p>
            <br>
            <p><strong>Current Status:</strong><br>
            Many third and fourth-generation Italian-Americans report understanding some Italian phrases but cannot maintain conversations. Interest in reclaiming heritage language is growing, with adult learners seeking to reconnect with their roots.</p>
            <br>
            <p><strong>Preservation Efforts:</strong><br>
            Italian cultural centers, language classes, and study abroad programs help heritage speakers reconnect with their linguistic heritage.</p>
        `
    },
    indigenous: {
        title: "Indigenous Language Rights",
        text: `
            <p><strong>Indigenous Languages Face Unique Challenges</strong></p>
            <br>
            <p>Indigenous communities worldwide experience the most severe language loss, with many languages critically endangered or already extinct.</p>
            <br>
            <p><strong>Historical Context:</strong><br>
            ‚Ä¢ Forced attendance at boarding schools where native languages were forbidden<br>
            ‚Ä¢ Systematic cultural suppression and assimilation policies<br>
            ‚Ä¢ Physical punishment for speaking heritage languages<br>
            ‚Ä¢ Intergenerational trauma affecting language transmission</p>
            <br>
            <p><strong>Current Crisis:</strong><br>
            UNESCO estimates that one indigenous language dies every two weeks. Many languages have fewer than 100 fluent speakers, and most are elderly.</p>
            <br>
            <p><strong>Revitalization Movements:</strong><br>
            ‚Ä¢ Language immersion schools (like Hawaiian language nests)<br>
            ‚Ä¢ Master-apprentice programs pairing elders with young learners<br>
            ‚Ä¢ Digital documentation and archiving projects<br>
            ‚Ä¢ Legal recognition of indigenous language rights<br>
            ‚Ä¢ Community-driven revitalization programs</p>
            <br>
            <p><strong>Success Stories:</strong><br>
            Hawaiian, MƒÅori, and some Native American languages have seen successful revitalization through dedicated community efforts and institutional support.</p>
        `
    },
    immigrant: {
        title: "Immigrant Community Languages",
        text: `
            <p><strong>The Immigrant Language Journey</strong></p>
            <br>
            <p>Immigrant communities across the globe face similar patterns of language shift and loss, regardless of the specific languages involved.</p>
            <br>
            <p><strong>Common Experiences:</strong><br>
            ‚Ä¢ Children become interpreters for parents, reversing family dynamics<br>
            ‚Ä¢ School systems that don't support bilingualism<br>
            ‚Ä¢ Peer pressure to speak only the dominant language<br>
            ‚Ä¢ Parents may stop speaking heritage language thinking it will help children succeed</p>
            <br>
            <p><strong>The "Linguistically Dead" Phenomenon:</strong><br>
            Many heritage speakers describe feeling "linguistically dead" when they lack fluency in their heritage language‚Äîexperiencing loss of connection to family history, culture, and identity.</p>
            <br>
            <p><strong>The Multilingual Advantage:</strong><br>
            Research consistently shows that bilingualism and multilingualism offer cognitive, social, and economic benefits. Children can be fully proficient in multiple languages with proper support.</p>
            <br>
            <p><strong>Supporting Heritage Language Development:</strong><br>
            ‚Ä¢ Consistent family language policies<br>
            ‚Ä¢ Access to books, media, and entertainment in heritage languages<br>
            ‚Ä¢ Community language schools and cultural programs<br>
            ‚Ä¢ Positive reinforcement and celebration of multilingualism<br>
            ‚Ä¢ Connection with extended family and homeland</p>
        `
    }
};

// Globe JavaScript
const canvas = document.getElementById('globeCanvas');
const ctx = canvas.getContext('2d');

let rotation = 0;
let autoRotate = true;
let isDragging = false;
let lastX = 0;
let animationId = null;

const globeRadius = 350;
let centerX = canvas.width / 2;
let centerY = canvas.height / 2;

// Pin locations (lat, lon, label, modalId)
const pins = [
    { lat: 42, lon: 12, label: 'üáÆüáπ Italy', id: 'italy' },
    { lat: 45, lon: -95, label: 'üåé Indigenous', id: 'indigenous' },
    { lat: 35, lon: 105, label: 'üá®üá≥ Asia', id: 'immigrant' },
    { lat: 0, lon: 20, label: 'üåç Africa', id: 'immigrant' },
    { lat: -25, lon: 135, label: 'üá¶üá∫ Australia', id: 'immigrant' }
];

function resizeCanvas() {
    const container = canvas.parentElement;
    const size = Math.min(container.clientWidth * 0.9, container.clientHeight * 0.9, 800);
    canvas.width = size;
    canvas.height = size;
    centerX = canvas.width / 2;
    centerY = canvas.height / 2;
}

function drawGlobe() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const actualRadius = Math.min(globeRadius, canvas.width / 2 - 20, canvas.height / 2 - 20);
    
    // Draw ocean
    ctx.beginPath();
    ctx.arc(centerX, centerY, actualRadius, 0, Math.PI * 2);
    ctx.fillStyle = '#4a90e2';
    ctx.fill();
    
    // Add gradient for depth
    const gradient = ctx.createRadialGradient(
        centerX - actualRadius * 0.3, centerY - actualRadius * 0.3, actualRadius * 0.2,
        centerX, centerY, actualRadius
    );
    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
    gradient.addColorStop(0.5, 'rgba(102, 126, 234, 0.2)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.3)');
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, actualRadius, 0, Math.PI * 2);
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Draw simplified continents
    drawContinents(actualRadius);
    
    // Draw pins
    pins.forEach(pin => {
        drawPin(pin, actualRadius);
    });
    
    // Draw globe outline
    ctx.beginPath();
    ctx.arc(centerX, centerY, actualRadius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 3;
    ctx.stroke();
}

function drawContinents(radius) {
    const scale = radius / globeRadius;
    const continents = [
        { points: [[240, 150], [280, 140], [290, 180], [270, 220], [230, 200]], rotation: 90 },
        { points: [[260, 250], [285, 240], [290, 290], [270, 310], [250, 290]], rotation: 90 },
        { points: [[350, 170], [370, 165], [375, 185], [365, 195], [345, 190]], rotation: 0 },
        { points: [[360, 230], [380, 220], [390, 270], [370, 300], [350, 280]], rotation: 0 },
        { points: [[420, 160], [480, 150], [500, 200], [480, 230], [430, 220]], rotation: -90 },
        { points: [[470, 320], [500, 315], [510, 340], [495, 355], [465, 345]], rotation: -90 }
    ];
    
    ctx.fillStyle = '#2d5016';
    ctx.globalAlpha = 0.7;
    
    continents.forEach(continent => {
        if (isVisible(continent.rotation)) {
            ctx.beginPath();
            const transformedPoints = continent.points.map(p => {
                const scaledX = centerX + (p[0] - 300) * scale;
                const scaledY = centerY + (p[1] - 300) * scale;
                return rotatePoint(scaledX, scaledY, rotation + continent.rotation);
            });
            
            ctx.moveTo(transformedPoints[0].x, transformedPoints[0].y);
            transformedPoints.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.closePath();
            ctx.fill();
        }
    });
    
    ctx.globalAlpha = 1;
}

function drawPin(pin, radius) {
    const pos = projectLatLon(pin.lat, pin.lon, radius);
    
    if (!pos.visible) return;
    
    const pinSize = radius / 30;
    
    // Pin body
    ctx.beginPath();
    ctx.arc(pos.x, pos.y - pinSize * 2, pinSize, 0, Math.PI * 2);
    ctx.fillStyle = '#ff6b6b';
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Pin point
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y - pinSize);
    ctx.lineTo(pos.x - pinSize * 0.6, pos.y);
    ctx.lineTo(pos.x + pinSize * 0.6, pos.y);
    ctx.closePath();
    ctx.fillStyle = '#ff6b6b';
    ctx.fill();
    
    // Label
    const fontSize = Math.max(12, radius / 30);
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth = 3;
    ctx.strokeText(pin.label, pos.x - 30, pos.y - pinSize * 3);
    ctx.fillText(pin.label, pos.x - 30, pos.y - pinSize * 3);
    
    // Store position for click detection
    pin.screenX = pos.x;
    pin.screenY = pos.y;
    pin.pinSize = pinSize * 3;
}

function projectLatLon(lat, lon, radius) {
    const phi = (90 - lat) * Math.PI / 180;
    const theta = (lon + rotation) * Math.PI / 180;
    
    const x = radius * Math.sin(phi) * Math.cos(theta);
    const y = radius * Math.cos(phi);
    const z = radius * Math.sin(phi) * Math.sin(theta);
    
    return {
        x: centerX + x * 0.8,
        y: centerY - y * 0.8,
        visible: z > 0
    };
}

function rotatePoint(x, y, angle) {
    const adjustedAngle = angle * Math.PI / 180;
    const cos = Math.cos(adjustedAngle);
    const sin = Math.sin(adjustedAngle);
    
    const relX = x - centerX;
    const relY = y - centerY;
    
    return {
        x: centerX + (relX * cos - relY * sin),
        y: centerY + (relX * sin + relY * cos)
    };
}

function isVisible(continentRotation) {
    const angle = (rotation + continentRotation) % 360;
    return angle > -90 && angle < 90;
}

function animate() {
    if (autoRotate) {
        rotation += 0.2;
        if (rotation >= 360) rotation = 0;
    }
    drawGlobe();
    animationId = requestAnimationFrame(animate);
}

function stopAnimation() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

// Mouse interactions
canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Check if clicked on a pin
    let clickedPin = false;
    pins.forEach(pin => {
        if (pin.screenX && pin.screenY && pin.pinSize) {
            const dx = x - pin.screenX;
            const dy = y - pin.screenY;
            if (Math.sqrt(dx*dx + dy*dy) < pin.pinSize) {
                openModal(pin.id);
                clickedPin = true;
            }
        }
    });
    
    if (!clickedPin) {
        isDragging = true;
        lastX = x;
    }
});

canvas.addEventListener('mousemove', (e) => {
    if (isDragging) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const deltaX = x - lastX;
        rotation += deltaX * 0.5;
        lastX = x;
        autoRotate = false;
    }
});

canvas.addEventListener('mouseup', () => {
    isDragging = false;
});

canvas.addEventListener('mouseleave', () => {
    isDragging = false;
});

// Touch events for mobile
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    let clickedPin = false;
    pins.forEach(pin => {
        if (pin.screenX && pin.screenY && pin.pinSize) {
            const dx = x - pin.screenX;
            const dy = y - pin.screenY;
            if (Math.sqrt(dx*dx + dy*dy) < pin.pinSize) {
                openModal(pin.id);
                clickedPin = true;
            }
        }
    });
    
    if (!clickedPin) {
        isDragging = true;
        lastX = x;
    }
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (isDragging) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const deltaX = x - lastX;
        rotation += deltaX * 0.5;
        lastX = x;
        autoRotate = false;
    }
});

canvas.addEventListener('touchend', () => {
    isDragging = false;
});

function toggleRotation() {
    autoRotate = !autoRotate;
}

function resetView() {
    rotation = 0;
    autoRotate = true;
}

// Page navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(pageId).classList.add('active');
    
    // Find and activate the corresponding nav button
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(pageId === 'bubbles' ? 'overview' : 'global')) {
            btn.classList.add('active');
        }
    });
    
    if (pageId === 'globe') {
        setTimeout(() => {
            resizeCanvas();
            if (!animationId) {
                animate();
            }
        }, 100);
    } else {
        stopAnimation();
    }
}

function openModal(contentId) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    
    modalTitle.textContent = content[contentId].title;
    modalText.innerHTML = content[contentId].text;
    
    modal.classList.add('active');
}

function closeModal(event) {
    if (!event || event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// Handle window resize
window.addEventListener('resize', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeCanvas();
    }
});

// Initialize on load
window.addEventListener('load', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeCanvas();
        animate();
    }
});
