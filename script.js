// Content for modals
const content = {
    why: {
        title: "Why Does Language Loss Happen?",
        text: `
            <p><strong>Language loss occurs due to several interconnected factors:</strong></p>
            <br>
            <p><strong>1. Migration & Displacement</strong><br>
            When families move to new countries, dominant languages often take precedence in education, work, and social integration. Children may prioritize the majority language to fit in with peers.</p>
            <br>
            <p><strong>2. Social Pressure & Stigma</strong><br>
            Heritage languages can be stigmatized or viewed as "less valuable" than dominant languages, leading speakers to abandon them in favor of linguistic assimilation.</p>
            <br>
            <p><strong>3. Limited Use in Daily Life</strong><br>
            When heritage languages aren't reinforced in schools, media, or public spaces, younger generations have fewer opportunities and motivations to maintain fluency.</p>
            <br>
            <p><strong>4. Generational Disconnect</strong><br>
            As older generations pass away, the primary speakers and cultural transmitters of heritage languages disappear, creating a critical break in language transmission.</p>
        `
    },
    how: {
        title: "How Language Loss Happens",
        text: `
            <p><strong>Language shift occurs through a predictable pattern:</strong></p>
            <br>
            <p><strong>Generation 1: Immigrants/Original Speakers</strong><br>
            Fully fluent in heritage language, limited proficiency in dominant language. Use heritage language at home.</p>
            <br>
            <p><strong>Generation 2: First Generation Born in New Country</strong><br>
            Bilingual but may prefer dominant language. Understand heritage language but respond in dominant language. Experience pressure to assimilate.</p>
            <br>
            <p><strong>Generation 3: Grandchildren</strong><br>
            Limited or no fluency in heritage language. May understand some phrases but cannot speak fluently. Primarily use dominant language in all contexts.</p>
            <br>
            <p><strong>The Critical Period</strong><br>
            Research shows that without active maintenance, heritage languages can be lost within 2-3 generations. The transition from Generation 2 to 3 is particularly critical.</p>
        `
    },
    effects: {
        title: "Effects of Language Loss",
        text: `
            <p><strong>The consequences extend far beyond communication:</strong></p>
            <br>
            <p><strong>1. Loss of Cultural Identity</strong><br>
            Language carries culture, traditions, and worldviews. When a language dies, unique ways of understanding and expressing reality disappear with it.</p>
            <br>
            <p><strong>2. Family Disconnect</strong><br>
            Grandchildren who cannot speak heritage languages struggle to communicate with grandparents, creating emotional distance and breaking family bonds.</p>
            <br>
            <p><strong>3. Feelings of Inadequacy</strong><br>
            Many heritage speakers report feeling "not enough"‚Äîneither fully fluent in heritage language nor fully accepted in the dominant culture. This creates identity struggles.</p>
            <br>
            <p><strong>4. Loss of Linguistic Diversity</strong><br>
            Each language represents unique knowledge systems, cognitive patterns, and cultural wisdom. Global linguistic diversity shrinks as languages disappear.</p>
            <br>
            <p><strong>5. Community Fragmentation</strong><br>
            Shared language creates community cohesion. Language loss can fragment ethnic communities and weaken social support networks.</p>
        `
    },
    solutions: {
        title: "Solutions & Revitalization",
        text: `
            <p><strong>Preventing and reversing language loss requires multi-level intervention:</strong></p>
            <br>
            <p><strong>1. Family-Level Strategies</strong><br>
            ‚Ä¢ Consistent use of heritage language at home<br>
            ‚Ä¢ Creating engaging, positive associations with the language<br>
            ‚Ä¢ Connecting children with fluent speakers (grandparents, community members)</p>
            <br>
            <p><strong>2. Educational Support</strong><br>
            ‚Ä¢ Heritage language classes in schools<br>
            ‚Ä¢ Dual-language immersion programs<br>
            ‚Ä¢ Reading materials and resources for young learners<br>
            ‚Ä¢ Validating multilingualism as an asset, not a deficit</p>
            <br>
            <p><strong>3. Community Resources</strong><br>
            ‚Ä¢ Language nests and cultural programs<br>
            ‚Ä¢ Media and entertainment in heritage languages<br>
            ‚Ä¢ Community events that celebrate linguistic diversity<br>
            ‚Ä¢ Digital resources and apps for language learning</p>
            <br>
            <p><strong>4. Policy & Institutional Change</strong><br>
            ‚Ä¢ Recognition of linguistic rights<br>
            ‚Ä¢ Funding for language preservation programs<br>
            ‚Ä¢ Reducing stigma around non-dominant languages<br>
            ‚Ä¢ Supporting heritage language research and documentation</p>
            <br>
            <p><strong>5. Embracing Multilingualism</strong><br>
            Research shows you can be fluent in multiple languages‚Äîit's beneficial for cognitive development, cultural identity, and professional opportunities. Language loss is preventable with the right support.</p>
        `
    },
    italy: {
        title: "Italian Language Heritage",
        text: `
            <p><strong>The Italian-American Experience</strong></p>
            <br>
            <p>Italian immigrants brought rich linguistic diversity to the United States, including various regional dialects. However, second and third-generation Italian-Americans often experienced significant language loss.</p>
            <br>
            <p><strong>Key Challenges:</strong><br>
            ‚Ä¢ Pressure to assimilate during the early-mid 20th century<br>
            ‚Ä¢ Italian was sometimes discouraged in schools<br>
            ‚Ä¢ Regional dialects (Sicilian, Neapolitan) were often replaced by Standard Italian or English<br>
            ‚Ä¢ Limited formal education in Italian language and culture</p>
            <br>
            <p><strong>Current Status:</strong><br>
            Many third and fourth-generation Italian-Americans report understanding some Italian phrases but cannot maintain conversations. Interest in reclaiming heritage language is growing, with adult learners seeking to reconnect with their roots.</p>
            <br>
            <p><strong>Preservation Efforts:</strong><br>
            Italian cultural centers, language classes, and study abroad programs help heritage speakers reconnect with their linguistic heritage.</p>
        `
    },
    indigenous: {
        title: "Indigenous Language Rights",
        text: `
            <p><strong>Indigenous Languages Face Unique Challenges</strong></p>
            <br>
            <p>Indigenous communities worldwide experience the most severe language loss, with many languages critically endangered or already extinct.</p>
            <br>
            <p><strong>Historical Context:</strong><br>
            ‚Ä¢ Forced attendance at boarding schools where native languages were forbidden<br>
            ‚Ä¢ Systematic cultural suppression and assimilation policies<br>
            ‚Ä¢ Physical punishment for speaking heritage languages<br>
            ‚Ä¢ Intergenerational trauma affecting language transmission</p>
            <br>
            <p><strong>Current Crisis:</strong><br>
            UNESCO estimates that one indigenous language dies every two weeks. Many languages have fewer than 100 fluent speakers, and most are elderly.</p>
            <br>
            <p><strong>Revitalization Movements:</strong><br>
            ‚Ä¢ Language immersion schools (like Hawaiian language nests)<br>
            ‚Ä¢ Master-apprentice programs pairing elders with young learners<br>
            ‚Ä¢ Digital documentation and archiving projects<br>
            ‚Ä¢ Legal recognition of indigenous language rights<br>
            ‚Ä¢ Community-driven revitalization programs</p>
            <br>
            <p><strong>Success Stories:</strong><br>
            Hawaiian, MƒÅori, and some Native American languages have seen successful revitalization through dedicated community efforts and institutional support.</p>
        `
    },
    immigrant: {
        title: "Immigrant Community Languages",
        text: `
            <p><strong>The Immigrant Language Journey</strong></p>
            <br>
            <p>Immigrant communities across the globe face similar patterns of language shift and loss, regardless of the specific languages involved.</p>
            <br>
            <p><strong>Common Experiences:</strong><br>
            ‚Ä¢ Children become interpreters for parents, reversing family dynamics<br>
            ‚Ä¢ School systems that don't support bilingualism<br>
            ‚Ä¢ Peer pressure to speak only the dominant language<br>
            ‚Ä¢ Parents may stop speaking heritage language thinking it will help children succeed</p>
            <br>
            <p><strong>The "Linguistically Dead" Phenomenon:</strong><br>
            Many heritage speakers describe feeling "linguistically dead" when they lack fluency in their heritage language‚Äîexperiencing loss of connection to family history, culture, and identity.</p>
            <br>
            <p><strong>The Multilingual Advantage:</strong><br>
            Research consistently shows that bilingualism and multilingualism offer cognitive, social, and economic benefits. Children can be fully proficient in multiple languages with proper support.</p>
            <br>
            <p><strong>Supporting Heritage Language Development:</strong><br>
            ‚Ä¢ Consistent family language policies<br>
            ‚Ä¢ Access to books, media, and entertainment in heritage languages<br>
            ‚Ä¢ Community language schools and cultural programs<br>
            ‚Ä¢ Positive reinforcement and celebration of multilingualism<br>
            ‚Ä¢ Connection with extended family and homeland</p>
        `
    }
};

// Globe JavaScript
const canvas = document.getElementById('globeCanvas');
const ctx = canvas.getContext('2d');

let rotation = 0;
let autoRotate = true;
let isDragging = false;
let lastX = 0;
let animationId = null;

let centerX = canvas.width / 2;
let centerY = canvas.height / 2;

// Pin locations (lat, lon, label, modalId)
const pins = [
    { lat: 42, lon: 12, label: 'üáÆüáπ Italy', id: 'italy' },
    { lat: 45, lon: -95, label: 'üåé Indigenous', id: 'indigenous' },
    { lat: 35, lon: 105, label: 'üá®üá≥ Asia', id: 'immigrant' },
    { lat: 0, lon: 20, label: 'üåç Africa', id: 'immigrant' },
    { lat: -25, lon: 135, label: 'üá¶üá∫ Australia', id: 'immigrant' }
];

// Detailed continent coordinates (longitude, latitude)
const continents = [
    // North America
    { name: 'North America', color: '#2d5016', points: [
        [-170, 65], [-160, 68], [-140, 70], [-130, 68], [-120, 65], [-110, 58], 
        [-100, 50], [-95, 45], [-90, 40], [-85, 35], [-80, 30], [-75, 25],
        [-72, 30], [-70, 40], [-65, 45], [-60, 48], [-55, 52], [-50, 58],
        [-60, 65], [-80, 70], [-100, 72], [-130, 72], [-150, 70], [-170, 65]
    ]},
    // Central America
    { name: 'Central America', color: '#2d5016', points: [
        [-105, 30], [-100, 28], [-95, 25], [-90, 20], [-85, 15], [-80, 12],
        [-78, 10], [-75, 8], [-82, 10], [-90, 12], [-95, 18], [-100, 22], [-105, 30]
    ]},
    // South America
    { name: 'South America', color: '#2d5016', points: [
        [-80, 12], [-75, 10], [-70, 5], [-65, 0], [-60, -5], [-57, -15],
        [-55, -25], [-52, -35], [-50, -45], [-55, -52], [-65, -55], [-72, -52],
        [-75, -45], [-77, -35], [-78, -25], [-80, -15], [-82, -5], [-80, 5], [-80, 12]
    ]},
    // Europe
    { name: 'Europe', color: '#3a6b1e', points: [
        [-10, 55], [-5, 60], [0, 62], [5, 65], [15, 68], [25, 70], [35, 68],
        [40, 65], [45, 60], [48, 55], [45, 50], [40, 45], [35, 42], [30, 40],
        [20, 38], [10, 37], [5, 40], [0, 43], [-5, 48], [-10, 52], [-10, 55]
    ]},
    // Africa
    { name: 'Africa', color: '#2d5016', points: [
        [-18, 35], [-15, 32], [-10, 28], [0, 25], [10, 23], [20, 20], [30, 18],
        [38, 15], [42, 10], [45, 5], [48, 0], [50, -5], [48, -12], [45, -18],
        [42, -25], [38, -30], [32, -33], [25, -35], [18, -34], [12, -30],
        [8, -25], [5, -18], [3, -10], [0, -2], [-5, 5], [-8, 12], [-12, 18],
        [-15, 25], [-17, 30], [-18, 35]
    ]},
    // Asia
    { name: 'Asia', color: '#2d5016', points: [
        [50, 70], [60, 72], [75, 73], [90, 72], [105, 70], [120, 68], [135, 65],
        [145, 60], [150, 55], [155, 48], [158, 42], [160, 35], [155, 28],
        [148, 22], [140, 18], [130, 15], [120, 12], [110, 10], [100, 8],
        [90, 8], [80, 10], [70, 15], [65, 22], [60, 30], [58, 38], [55, 45],
        [52, 52], [50, 60], [50, 70]
    ]},
    // Australia
    { name: 'Australia', color: '#2d5016', points: [
        [113, -10], [120, -12], [128, -14], [135, -16], [142, -18], [148, -22],
        [152, -27], [154, -32], [153, -37], [150, -40], [145, -42], [138, -43],
        [130, -42], [122, -40], [116, -36], [112, -30], [110, -22], [111, -16], [113, -10]
    ]},
    // Greenland
    { name: 'Greenland', color: '#2d5016', points: [
        [-45, 83], [-40, 82], [-30, 80], [-25, 78], [-22, 75], [-20, 70],
        [-23, 65], [-28, 62], [-35, 60], [-42, 62], [-48, 65], [-52, 68],
        [-50, 73], [-48, 78], [-45, 83]
    ]}
];

function resizeCanvas() {
    const container = canvas.parentElement;
    const size = Math.min(container.clientWidth * 0.95, container.clientHeight * 0.95, 1000);
    canvas.width = size;
    canvas.height = size;
    centerX = canvas.width / 2;
    centerY = canvas.height / 2;
}

function drawGlobe() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const radius = Math.min(canvas.width, canvas.height) / 2 - 40;
    
    // Draw ocean with gradient
    const oceanGradient = ctx.createRadialGradient(
        centerX - radius * 0.3, centerY - radius * 0.3, 0,
        centerX, centerY, radius
    );
    oceanGradient.addColorStop(0, '#5b9bd5');
    oceanGradient.addColorStop(0.5, '#3a7cb8');
    oceanGradient.addColorStop(1, '#1e4d7a');
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = oceanGradient;
    ctx.fill();
    
    // Add lighting effect
    const lightGradient = ctx.createRadialGradient(
        centerX - radius * 0.4, centerY - radius * 0.4, radius * 0.2,
        centerX, centerY, radius
    );
    lightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
    lightGradient.addColorStop(0.4, 'rgba(255, 255, 255, 0.1)');
    lightGradient.addColorStop(1, 'rgba(0, 0, 0, 0.2)');
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = lightGradient;
    ctx.fill();
    
    // Draw continents
    continents.forEach(continent => {
        drawContinent(continent, radius);
    });
    
    // Draw pins
    pins.forEach(pin => {
        drawPin(pin, radius);
    });
    
    // Draw globe outline
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.lineWidth = 3;
    ctx.stroke();
}

function drawContinent(continent, radius) {
    const transformedPoints = [];
    
    // Transform all points
    for (let i = 0; i < continent.points.length; i++) {
        const lon = continent.points[i][0];
        const lat = continent.points[i][1];
        const pos = projectLatLon(lat, lon, radius);
        transformedPoints.push(pos);
    }
    
    // Check if any points are visible
    const hasVisiblePoints = transformedPoints.some(p => p.visible);
    
    if (!hasVisiblePoints) return;
    
    // Draw the continent
    ctx.save();
    
    // Clip to globe circle
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.clip();
    
    // Draw continent fill
    ctx.beginPath();
    let started = false;
    
    for (let i = 0; i < transformedPoints.length; i++) {
        const point = transformedPoints[i];
        
        if (point.visible) {
            if (!started) {
                ctx.moveTo(point.x, point.y);
                started = true;
            } else {
                ctx.lineTo(point.x, point.y);
            }
        }
    }
    
    ctx.closePath();
    ctx.fillStyle = continent.color;
    ctx.globalAlpha = 0.95;
    ctx.fill();
    
    // Add continent outline
    ctx.strokeStyle = 'rgba(0, 50, 0, 0.4)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    
    ctx.globalAlpha = 1;
    ctx.restore();
}

function drawPin(pin, radius) {
    const pos = projectLatLon(pin.lat, pin.lon, radius);
    
    if (!pos.visible) return;
    
    const pinSize = radius / 15; // Made pins bigger
    
    // Pin shadow
    ctx.beginPath();
    ctx.arc(pos.x + 3, pos.y + 3, pinSize * 1.2, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    ctx.fill();
    
    // Pin body
    ctx.beginPath();
    ctx.arc(pos.x, pos.y - pinSize * 1.5, pinSize, 0, Math.PI * 2);
    ctx.fillStyle = '#ff4757';
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.stroke();
    
    // Pin point
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y - pinSize * 0.5);
    ctx.lineTo(pos.x - pinSize * 0.8, pos.y + pinSize * 0.5);
    ctx.lineTo(pos.x + pinSize * 0.8, pos.y + pinSize * 0.5);
    ctx.closePath();
    ctx.fillStyle = '#ff4757';
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Label with background
    const fontSize = Math.max(14, radius / 25);
    ctx.font = `bold ${fontSize}px Arial`;
    const textWidth = ctx.measureText(pin.label).width;
    
    // Label background
    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
    ctx.fillRect(pos.x - textWidth/2 - 8, pos.y - pinSize * 3.5 - fontSize - 4, textWidth + 16, fontSize + 8);
    
    // Label text
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(pin.label, pos.x, pos.y - pinSize * 3.5);
    
    // Store position for click detection
    pin.screenX = pos.x;
    pin.screenY = pos.y;
    pin.pinSize = pinSize * 3;
}

function projectLatLon(lat, lon, radius) {
    // Convert to radians
    const phi = (90 - lat) * Math.PI / 180;
    const theta = (lon + rotation) * Math.PI / 180;
    
    // 3D projection
    const x = radius * Math.sin(phi) * Math.cos(theta);
    const y = radius * Math.cos(phi);
    const z = radius * Math.sin(phi) * Math.sin(theta);
    
    // Determine visibility - points are visible if they're on the front hemisphere
    const visible = z > -radius * 0.15;
    
    return {
        x: centerX + x,
        y: centerY - y,
        z: z,
        visible: visible
    };
}

function animate() {
    if (autoRotate) {
        rotation += 0.2;
        if (rotation >= 360) rotation = 0;
    }
    drawGlobe();
    animationId = requestAnimationFrame(animate);
}

function stopAnimation() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

// Mouse interactions
canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Check if clicked on a pin
    let clickedPin = false;
    pins.forEach(pin => {
        if (pin.screenX && pin.screenY && pin.pinSize) {
            const dx = x - pin.screenX;
            const dy = y - pin.screenY;
            if (Math.sqrt(dx*dx + dy*dy) < pin.pinSize) {
                openModal(pin.id);
                clickedPin = true;
            }
        }
    });
    
    if (!clickedPin) {
        isDragging = true;
        lastX = x;
    }
});

canvas.addEventListener('mousemove', (e) => {
    if (isDragging) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const deltaX = x - lastX;
        rotation += deltaX * 0.5;
        lastX = x;
        autoRotate = false;
    }
});

canvas.addEventListener('mouseup', () => {
    isDragging = false;
});

canvas.addEventListener('mouseleave', () => {
    isDragging = false;
});

// Touch events for mobile
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    let clickedPin = false;
    pins.forEach(pin => {
        if (pin.screenX && pin.screenY && pin.pinSize) {
            const dx = x - pin.screenX;
            const dy = y - pin.screenY;
            if (Math.sqrt(dx*dx + dy*dy) < pin.pinSize) {
                openModal(pin.id);
                clickedPin = true;
            }
        }
    });
    
    if (!clickedPin) {
        isDragging = true;
        lastX = x;
    }
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (isDragging) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const deltaX = x - lastX;
        rotation += deltaX * 0.5;
        lastX = x;
        autoRotate = false;
    }
});

canvas.addEventListener('touchend', () => {
    isDragging = false;
});

function toggleRotation() {
    autoRotate = !autoRotate;
}

function resetView() {
    rotation = 0;
    autoRotate = true;
}

// Page navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(pageId).classList.add('active');
    
    // Find and activate the corresponding nav button
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(pageId === 'bubbles' ? 'overview' : 'global')) {
            btn.classList.add('active');
        }
    });
    
    if (pageId === 'globe') {
        setTimeout(() => {
            resizeCanvas();
            if (!animationId) {
                animate();
            }
        }, 100);
    } else {
        stopAnimation();
    }
}

function openModal(contentId) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    
    modalTitle.textContent = content[contentId].title;
    modalText.innerHTML = content[contentId].text;
    
    modal.classList.add('active');
}

function closeModal(event) {
    if (!event || event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// Handle window resize
window.addEventListener('resize', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeCanvas();
    }
});

// Initialize on load
window.addEventListener('load', () => {
    if (document.getElementById('globe').classList.contains('active')) {
        resizeCanvas();
        animate();
    }
});
